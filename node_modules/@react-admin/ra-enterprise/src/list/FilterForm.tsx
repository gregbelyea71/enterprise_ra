import * as React from 'react';
import { ComponentProps, useContext } from 'react';
import {
    FilterContext,
    FilterForm as RaFilterForm,
    useListContext,
} from 'react-admin';
import get from 'lodash/get';
import classnames from 'classnames';
import { makeStyles } from '@material-ui/core';

/**
 * A customized version of react-admin FilterForm component which takes less
 * space when there are no filters.
 */
export const FilterForm = (props: ComponentProps<typeof RaFilterForm>) => {
    const { filters: filtersProps, initialValues } = props;
    const { displayedFilters = {} } = useListContext(props);
    const classes = useStyles();
    const filters = useContext(FilterContext) || filtersProps;

    const shownFilters = filters.filter(
        (filterElement: JSX.Element) =>
            filterElement.props.alwaysOn ||
            displayedFilters[filterElement.props.source] ||
            typeof get(initialValues, filterElement.props.source) !==
                'undefined'
    );

    return (
        <RaFilterForm
            {...props}
            className={classnames({
                [classes.emptyForm]: shownFilters.length === 0,
            })}
        />
    );
};

const useStyles = makeStyles(theme => ({
    emptyForm: {
        minHeight: theme.spacing(2),
    },
}));
